<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.iei.match.model.dao.MatchDao">
	<select id="calcPrice" resultType="grade">
		select * from grade 
			where match_count = #{matchCount} and member_gender = #{memberGender} and member_grade = #{memberGrade} and member_age like SUBSTR(#{memberAge}, 1,1)||'%' 
	</select>
	
	<insert id="insertPayData">
		insert into member_pay_table values(pay_seq.nextval,#{memberId},#{payPrice},#{payName},#{payState}, sysdate)
	</insert>
	<insert id="matchEnroll">
		insert all
			when #{memberGrade} = 'silver' then
				into match_mypage values(match_seq.nextval,#{memberId},#{memberGrade},sysdate,default,#{matchField},#{matchAge},#{matchJob},#{matchMbti},#{matchHobby},null,null,null)
			when #{memberGrade} = 'gold' then
				into match_mypage values(match_seq.nextval,#{memberId},#{memberGrade},sysdate,default,#{matchField},#{matchAge},#{matchJob},#{matchMbti},#{matchHobby},#{matchEdu},null,null)
			when #{memberGrade} = 'platinum' then
				into match_mypage values(match_seq.nextval,#{memberId},#{memberGrade},sysdate,default,#{matchField},#{matchAge},#{matchJob},#{matchMbti},#{matchHobby},#{matchEdu},#{matchSalary},#{matchWorkType})
		select * from dual		
	</insert>
	
	<select id="selectMatchList" resultType="match">
		select match_no, 
				member_id, 
				m.member_grade, 
				match_date, 
				match_status, 
				match_field, 
				match_age, 
				match_job, 
				match_mbti,
				match_hobby,
				match_edu,
				match_salary,
				match_work_type,
				m.member_gender,
				m.member_name,
				m.member_img_path
			from match_mypage p join member m using(member_id)
	</select>
	
	<select id="findMatch" resultType="match">
		select match_no, 
				member_id, 
				m.member_grade, 
				match_date, 
				match_status, 
				match_field, 
				match_age, 
				match_job, 
				match_mbti,
				mmi.member_hobby as match_hobby,
				mmi.member_edu as match_edu,
				mmi.member_work_type as match_work_type,
				m.member_gender,
				m.member_name,
				m.member_img_path 
			from match_mypage p 
			join member m using(member_id)
			join member_more_info mmi using(member_no)
			
			where m.member_grade = #{memberGrade} 
					and member_addr like '%'||#{matchField}||'%' 
					and SUBSTR(to_char(SYSDATE , 'YYYY') - SUBSTR(m.birth_date, 1,4), 1 ,1) = SUBSTR(#{matchAge}, 1, 1) 
					and member_job = #{matchJob} 
					and member_mbti = #{matchMbti} 
					and member_hobby = #{matchHobby} 
					and m.member_gender = #{memberGender}
					and match_status = '대기중'
					
				<if test="memberGrade == 'gold' || memberGrade == 'platinum'">	
					 and mmi.member_edu = #{matchEdu}
				</if>
				<if test="memberGrade == 'platinum'"> 	
					 and mmi.member_work_type = #{matchWorkType}
					 and mmi.member_salary = #{matchSalary}
				</if>	 
	</select>
	
	<insert id="matchComplete">
		insert into match_admin values(match_admin_seq.nextval, default, default, default, SYSDATE , #{matchNo1}, #{matchNo2})
	</insert>
	
	<update id="updateStatus">
		update match_mypage set match_status = '매칭중' where match_no in (#{matchNo1}, #{matchNo2}) 
	</update>
	
	<select id="matchingList" resultType="matchAdmin">
		select admin_no,
			status,
			match_date, 
			member_pass_1, 
			member_pass_2, 
			m1.member_name as member_name_1, 
			m2.member_name as member_name_2 
			from match_admin
			join match_mypage mp1 on(match_no_1 = mp1.match_no)
			join match_mypage mp2 on(match_no_2 = mp2.match_no)
			join member m1 on(mp1.member_id = m1.member_id)
			join member m2 on(mp2.member_id = m2.member_id)

	</select>
</mapper>
